<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Cart | Student Portal</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Payment Gateway Scripts (for mock/local functionality, but included) -->
    <script src="https://js.stripe.com/v3/"></script>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    <!-- QR Code Library -->
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
    <!-- Custom JavaScript -->
    <script src="/static/js/main.js" defer></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style>
        /* CSS styles remain the same */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #e0e7ff; }
        ::-webkit-scrollbar-thumb { background: #4f46e5; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #3730a3; }

        html { font-family: 'Inter', sans-serif; }
        .shadow-deep {
            box-shadow: 0 15px 30px -10px rgba(79, 70, 229, 0.2), 0 5px 10px -5px rgba(0, 0, 0, 0.1);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #4f46e5 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-image: linear-gradient(to right, #8b5cf6 0%, #4f46e5 100%);
            transform: translateY(-2px);
            box-shadow: 0 15px 25px -5px rgba(79, 70, 229, 0.4);
        }
        .btn-primary:active {
            transform: translateY(0);
            box-shadow: 0 5px 10px -5px rgba(79, 70, 229, 0.4);
        }
        .view-hidden {
            display: none;
        }
        .splash-card-image {
            object-fit: cover;
            width: 100%;
            height: 100%;
        }
        .animate-pulse-slow {
            animation: pulse-slow 4s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse-slow {
            0%, 100% { opacity: 1; }
            50% { opacity: .5; }
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .product-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }
        @media (min-width: 1024px) { 
            .product-card-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
        }
        @media (min-width: 1280px) { 
            .product-card-grid {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }
        }
        .search-bar-container {
            flex-grow: 1;
            max-width: 700px;
            margin: 0 1rem;
        }
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            background: #e0e0e0;
            border-radius: 5px;
            outline: none;
            opacity: 0.7;
            -webkit-transition: .2s;
            transition: opacity .2s;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #ffffff;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #4f46e5;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid #ffffff;
            box-shadow: 0 0 5px rgba(0,0,0,0.2);
        }
        .range-slider {
            position: relative;
            height: 20px;
            padding: 0 5px;
        }
        .range-slider .range-fill {
            position: absolute;
            height: 8px;
            background: #8b5cf6;
            border-radius: 5px;
            top: 6px;
        }
    </style>
    <script>
        // --- CONFIGURATION & STATE ---
        const API_BASE_URL = 'http://127.0.0.1:8000/api';
        const IS_MOCKING_API = true; // Set to true to use mock data for a live demo

        // Helper function to get CSRF token (Not needed in this client-only demo, but kept for completeness)
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        let currentView = 'splash';
        
        let products = [];
        let cart = {};
        
        let customXeroxQuantity = 0;
        let uploadedFileName = ''; 
        const XEROX_PRICE_PER_PAGE = 0.50;
        const XEROX_PRODUCT_ID = 999;
        
        let userId = 'student-xyz-123'; 
        let searchQuery = ''; 
        let activeCategory = 'All'; 
        let sortBy = 'featured';
        
        let deliveryFilters = {
            allPrime: false, primeDelivery: false, tomorrowBy11AM: false, getItByTomorrow: false, getItIn2Days: false
        };
        let priceRange = { min: 0, max: 1000 };
        let selectedPriceFilter = 'All';
        let dealFilters = {
            allDiscounts: false, todayDeals: false
        };

        // --- API INTEGRATION FUNCTIONS ---

        /**
         * Fetches products from the Django API, including all products regardless of availability.
         */
        async function fetchProducts() {
            const productGrid = document.getElementById('product-grid-container');
            if (productGrid) {
                productGrid.innerHTML = '<div class="col-span-full text-center text-lg text-indigo-600 font-semibold py-12">Loading Products...</div>';
            } else {
                console.error('Product grid container not found when trying to fetch products');
                return;
            }
            
            try {
                console.log('Fetching products from /api/products/');
                
                const response = await fetch('/api/products/');
                
                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`HTTP error! status: ${response.status}, response: ${errorText}`);
                }
                
                const data = await response.json();
                console.log('API Response:', data);
                
                // Handle paginated response (Django REST framework uses 'results' for paginated responses)
                let productList = Array.isArray(data) ? data : (data.results || []);
                
                if (productList.length === 0) {
                    console.warn('No products returned from API. If you just added products, try refreshing the page.');
                }
                
                // Process products to ensure they have required fields
                products = productList.map(product => {
                    // Log each product for debugging
                    console.log('Processing product:', product);
                    return {
                        id: product.id,
                        name: product.name || 'Unnamed Product',
                        description: product.description || 'No description available',
                        price: parseFloat(product.price) || 0,
                        category: product.category || 'Uncategorized',
                        image: product.image || 'https://placehold.co/100x100/d1d5db/374151?text=No+Image',
                        is_available: product.is_available !== false,
                        stock: product.stock_quantity || product.stock || 0,
                        stock_quantity: product.stock_quantity || product.stock || 0
                    };
                });
                
                console.log('Processed products:', products);
                
                // After updating products, render them
                renderProducts();
                
                if (products.length === 0) {
                    console.warn('No products found in the API response');
                    if (productGrid) {
                        productGrid.innerHTML = `
                            <div class="col-span-full text-center py-12">
                                <div class="text-yellow-600 text-lg font-semibold mb-2">No products available</div>
                                <p class="text-gray-600 mb-4">There are no products in the store yet.</p>
                            </div>`;
                    }
                    return;
                }
                
                // Process products to ensure they have required fields
                products = products.map(product => ({
                    id: product.id,
                    name: product.name || 'Unnamed Product',
                    description: product.description || 'No description available',
                    price: parseFloat(product.price) || 0,
                    category: product.category || 'Uncategorized',
                    image: product.image || 'https://placehold.co/100x100/d1d5db/374151?text=No+Image',
                    is_available: product.is_available !== false,
                    stock: product.stock_quantity || product.stock || 0,
                    stock_quantity: product.stock_quantity || product.stock || 0
                }));
                
                console.log('Processed products:', products);
                
                // After updating products, render them
                renderProducts();
                
            } catch (error) {
                console.error('Error fetching products:', error);
                const errorMessage = error.message || 'Failed to load products. Please try again later.';
                
                // Try to find the product grid container again
                const errorContainer = document.getElementById('product-grid-container') || 
                                     document.querySelector('.product-card-grid') ||
                                     document.body;
                
                errorContainer.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <div class="text-red-500 text-lg font-semibold mb-2">Error loading products</div>
                        <p class="text-gray-600 mb-4">${errorMessage}</p>
                        <button onclick="fetchProducts()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700">
                            Try Again
                        </button>
                    </div>`;
                
                // Also log to console for debugging
                console.error('Product loading error details:', {
                    error: error,
                    timestamp: new Date().toISOString(),
                    products: products
                });
            }
        }

        /**
         * Fetches available time slots from Django API or generates mock data.
         */
        async function fetchTimeSlots() {
            // First try to get slots from the API if not in mock mode
            if (!IS_MOCKING_API) {
                try {
                    const response = await fetch(`${API_BASE_URL}/time_slots/`);
                    if (response.ok) {
                        const slots = await response.json();
                        if (slots && slots.length > 0) {
                            return slots;
                        }
                    }
                } catch (error) {
                    console.error("Error fetching time slots:", error);
                }
            }
            
            // Fall back to mock data if API fails or if in mock mode
            console.log("Using mock time slots data");
            return generateMockTimeSlots();
        }

        async function populateTimeSlots() {
            const slotSelect = document.getElementById('pickup-time-slot');
            if (!slotSelect) return;

            slotSelect.innerHTML = '<option value="">-- Loading Available Slots... --</option>';

            try {
                const slots = await fetchTimeSlots();
                const today = new Date().toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                
                // Clear and add default option
                slotSelect.innerHTML = '<option value="">-- Select Your 15-Minute Slot --</option>';

                if (!slots || slots.length === 0) {
                    slotSelect.innerHTML += `<option value="" disabled>No available time slots found. Please try again later.</option>`;
                    return;
                }

                // Group slots by date
                const todaySlots = [];
                const tomorrowSlots = [];
                const now = new Date();
                
                slots.forEach(slot => {
                    // Check if the slot is for today or tomorrow based on the is_today flag or time
                    const slotTime = new Date();
                    const [startTime, endTime] = (slot.text || '').split(' - ');
                    
                    if (slot.is_today === false || (slot.text && slot.text.includes('Tomorrow'))) {
                        tomorrowSlots.push(slot);
                    } else {
                        // For today's slots, check if they're in the past
                        if (startTime) {
                            // Simple time parsing for mock check - adjust for real production use
                            const [timePart] = startTime.split(' '); // e.g., "08:00" from "08:00 AM"
                            const [hours, minutes] = timePart.split(':').map(Number);

                            let finalHours = hours;
                            // Basic AM/PM logic for the mock
                            if (startTime.includes('PM') && finalHours < 12) finalHours += 12;
                            if (startTime.includes('AM') && finalHours === 12) finalHours = 0; // Midnight 12 AM

                            slotTime.setHours(finalHours, minutes, 0, 0);
                            slot.is_available = slotTime.getTime() > now.getTime() - (5 * 60000); // 5-minute buffer
                        }
                        todaySlots.push(slot);
                    }
                });

                // Add today's slots
                if (todaySlots.length > 0) {
                    const todayHeader = document.createElement('optgroup');
                    todayHeader.label = `Today (${today})`;
                    slotSelect.appendChild(todayHeader);
                    
                    todaySlots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.id || slot.value || '';
                        option.textContent = slot.text || `${slot.start_time} - ${slot.end_time}`;
                        
                        // Disable if slot is not available
                        if (slot.is_available === false) {
                            option.disabled = true;
                            option.textContent += ' (Unavailable)';
                            option.style.color = '#9CA3AF'; // Gray out unavailable slots
                        }
                        
                        todayHeader.appendChild(option);
                    });
                }
                
                // Add tomorrow's slots if any
                if (tomorrowSlots.length > 0) {
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    const tomorrowStr = tomorrow.toLocaleDateString('en-US', { weekday: 'long', month: 'short', day: 'numeric' });
                    
                    const tomorrowHeader = document.createElement('optgroup');
                    tomorrowHeader.label = `Tomorrow (${tomorrowStr})`;
                    slotSelect.appendChild(tomorrowHeader);
                    
                    tomorrowSlots.forEach(slot => {
                        const option = document.createElement('option');
                        option.value = slot.id || slot.value || '';
                        // Remove 'Tomorrow: ' prefix if it exists
                        const displayText = (slot.text || '').replace('Tomorrow: ', '');
                        option.textContent = displayText || `${slot.start_time} - ${slot.end_time}`;
                        tomorrowHeader.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error populating time slots:', error);
                slotSelect.innerHTML = `
                    <option value="">-- Select Time Slot --</option>
                    <option value="" disabled>Error loading time slots. Please try again.</option>
                `;
            }
        }
        
        async function handleCheckoutSubmit() {
            const timeSlotSelect = document.getElementById('pickup-time-slot');
            const paymentMethodElement = document.querySelector('input[name="payment-method"]:checked');
            const confirmButton = document.getElementById('confirm-order-btn');
            
            // Get values from the form
            const timeSlotId = timeSlotSelect ? timeSlotSelect.value : '';
            const paymentMethod = paymentMethodElement ? paymentMethodElement.value : '';
            
            // Validate inputs
            if (!timeSlotId || !paymentMethod) {
                showToast("Please select time slot and payment method.", 'warning');
                return;
            }

            if (customXeroxQuantity > 0 && uploadedFileName === '') {
                showToast("Please upload your document for Xeroxing or set page count to zero.", 'warning');
                return;
            }

            if (confirmButton) {
                confirmButton.disabled = true;
                confirmButton.textContent = 'Processing...';
            }
        
            try {
                // Mock Order Creation & Payment Simulation
                await new Promise(resolve => setTimeout(resolve, 1500)); // Simulate network delay

                // Simulate order creation response data
                const totalAmount = Array.from(Object.entries(cart)).reduce((sum, [id, qty]) => {
                    const product = products.find(p => p.id === parseInt(id));
                    return sum + (product ? product.price * qty : 0);
                }, 0);
                
                // Create mock items list for confirmation page
                const mockItems = Object.keys(cart).map(id => {
                    return { product_id: id, quantity: cart[id] };
                });

                const mockOrder = {
                    id: Math.floor(Math.random() * 100000),
                    order_code: `CC${Math.floor(Math.random() * 90000) + 10000}`,
                    total_amount: totalAmount,
                    pickup_slot_display: timeSlotSelect.options[timeSlotSelect.selectedIndex].textContent,
                    pickup_code: `PK${Math.floor(Math.random() * 900) + 100}`,
                    items: mockItems // Attach items for cancellation logic check
                };

                // Simulate payment success for online methods (no actual gateway interaction here)
                if (paymentMethod === 'online' || paymentMethod === 'razorpay') {
                    showToast('Payment successful! Your order has been placed.', 'success');
                } else if (paymentMethod === 'cod') {
                    showToast('Order placed successfully! Pay when you pick up.', 'success');
                }
                
                processOrderSuccess(mockOrder.id, mockOrder);

            } catch (error) {
                console.error('Checkout error:', error);
                showToast(error.message || 'An error occurred during checkout', 'error');
                if (confirmButton) {
                    confirmButton.disabled = false;
                    confirmButton.textContent = 'Confirm Order & Pay';
                }
            }        
        }
        /**
         * Cleans up after a successful order and updates the UI.
         * @param {number|string} orderId - The ID of the created order
         * @param {object} orderData - The full order response object
         */
        function processOrderSuccess(orderId, orderData) {
            // 1. Clear the local cart state
            cart = {};
            // 2. Clear custom xerox service items
            customXeroxQuantity = 0;
            uploadedFileName = '';
            
            // 3. Update the UI
            updateMobileCartDisplay();
            renderCart(); // Clear the cart view
            
            // 4. Update order confirmation details
            const orderCodeElement = document.getElementById('order-code-display');
            const orderPickupTimeElement = document.getElementById('pickup-time-display');
            const qrMockTextElement = document.getElementById('qr-mock-text');
            const cancellationDetailsElement = document.getElementById('cancellation-details');
            const shopkeeperQrElement = document.getElementById('shopkeeper-qr-code');
            
            const selectedSlot = document.getElementById('pickup-time-slot');
            const pickupTimeText = selectedSlot ? selectedSlot.options[selectedSlot.selectedIndex].textContent : 'ASAP';

            const paymentMethodElement = document.querySelector('input[name="payment-method"]:checked');
            const paymentMethod = paymentMethodElement ? paymentMethodElement.value : 'cod'; // Default to COD if somehow unchecked
            const totalAmount = orderData.total_amount || 0;

            if (orderCodeElement) orderCodeElement.textContent = orderData.order_code || `ORD-${orderId}`;
            if (orderPickupTimeElement) orderPickupTimeElement.textContent = orderData.pickup_slot_display || pickupTimeText || 'ASAP';

            // Generate appropriate QR code based on payment method
            if (shopkeeperQrElement) {
                // Clear any existing QR code
                shopkeeperQrElement.innerHTML = '';
                
                // Create payment data based on payment method
                let qrData = '';
                let qrTitle = '';
                
                if (paymentMethod === 'online') {
                    // UPI Payment QR
                    const upiId = 'shopkeeper@upi'; // Replace with actual shopkeeper's UPI ID
                    qrData = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=Shopkeeper&am=${totalAmount.toFixed(2)}&cu=INR&tn=Order-${orderId}`;
                    qrTitle = `UPI Payment | ‚Çπ${totalAmount.toFixed(2)}`;
                } else if (paymentMethod === 'razorpay') {
                    // Razorpay payment reference
                    const paymentRef = `razorpay_${Date.now()}`;
                    qrData = `razorpay:order?amount=${Math.round(totalAmount * 100)}&currency=INR&receipt=order_${orderId}`;
                    qrTitle = `Razorpay Payment | ‚Çπ${totalAmount.toFixed(2)}`;
                } else {
                    // COD or default
                    qrData = `Order: ${orderId}\nAmount: ‚Çπ${totalAmount.toFixed(2)}\nPayment: At Counter`;
                    qrTitle = `Pay at Counter | ‚Çπ${totalAmount.toFixed(2)}`;
                }
                
                // Generate the QR code
                new QRCode(shopkeeperQrElement, {
                    text: qrData,
                    width: 160,
                    height: 160,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H
                });
                
                // Update the QR code title
                if (qrMockTextElement) {
                    qrMockTextElement.textContent = qrTitle;
                }
            } else if (qrMockTextElement) {
                // Fallback text if QR code couldn't be generated
                const totalAmount = orderData.total_amount.toFixed(2);
                if (paymentMethod === 'cod') {
                    qrMockTextElement.innerHTML = `Payment Method: <span class="text-green-600 font-bold">Pay at Pickup</span> | Total: ‚Çπ${totalAmount}`;
                } else {
                    qrMockTextElement.innerHTML = `Payment Method: <span class="text-indigo-600 font-bold">Online</span> | Total: ‚Çπ${totalAmount}`;
                }
            }

            if (cancellationDetailsElement) {
                // Ensure orderData.items is an array before checking
                const itemsToCheck = Array.isArray(orderData.items) ? orderData.items : [];
                const hasXerox = itemsToCheck.some(item => parseInt(item.product_id) === XEROX_PRODUCT_ID && item.quantity > 0);
                if (hasXerox) {
                    cancellationDetailsElement.textContent = '‚ùå NOTE: This order includes a custom Xerox service. Cancellation or missed pickup will result in a deduction equal to the full xerox service cost.';
                } else {
                    cancellationDetailsElement.textContent = 'üìù Orders not collected within the 15-minute slot will be automatically cancelled.';
                }
            }

            // 5. Switch to confirmation view
            switchView('confirmation');
            fetchProducts(); 
        }

        // --- MOCK Time Slot Generation (Fallback if IS_MOCKING_API is true) ---
        function generateMockTimeSlots() {
            const now = new Date();
            const slots = [];
            
            // Define all possible slot times
            const allPossibleSlots = [
                { hour: 8, minute: 0, label: 'Morning' },
                { hour: 9, minute: 0, label: 'Morning' },
                { hour: 10, minute: 0, label: 'Morning' },
                { hour: 10, minute: 30, label: '1st break' },
                { hour: 11, minute: 0, label: 'Morning' },
                { hour: 11, minute: 30, label: 'Morning' },
                { hour: 12, minute: 0, label: 'Lunch' },
                { hour: 12, minute: 30, label: '2nd break' },
                { hour: 13, minute: 0, label: 'Afternoon' },
                { hour: 14, minute: 0, label: 'Afternoon' },
                { hour: 15, minute: 0, label: 'Afternoon' },
                { hour: 15, minute: 30, label: '3rd break' },
                { hour: 16, minute: 0, label: 'Evening' },
                { hour: 17, minute: 0, label: 'Final pickup window' },
                { hour: 18, minute: 0, label: 'Evening' }
            ];

            // Helper to format time as HH:MM AM/PM
            const formatTime = (hour, minute) => {
                const date = new Date(2000, 0, 1, hour, minute); // Arbitrary date
                return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', hour12: true });
            };

            // Add today's slots
            allPossibleSlots.forEach((slot, index) => {
                const slotTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), slot.hour, slot.minute, 0);
                const slotEnd = new Date(slotTime.getTime() + 15 * 60000);
                const startStr = formatTime(slot.hour, slot.minute);
                const endStr = formatTime(slotEnd.getHours(), slotEnd.getMinutes());
                
                let label = '';
                if (slot.label.includes('break')) {
                    label = ` (${slot.label})`;
                }
                
                // Check if the slot is in the past (within a 5-minute buffer)
                const isPastSlot = slotTime.getTime() < now.getTime() - (5 * 60000); 
                
                slots.push({
                    id: `today-${index}`,
                    value: `today-${index}`,
                    text: `${startStr} - ${endStr}${label}`,
                    start_time: startStr,
                    end_time: endStr,
                    is_available: !isPastSlot, 
                    is_today: true
                });
            });
            
            // Add tomorrow's slots
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            allPossibleSlots.forEach((slot, index) => {
                const slotTime = new Date(tomorrow.getFullYear(), tomorrow.getMonth(), tomorrow.getDate(), slot.hour, slot.minute, 0);
                const slotEnd = new Date(slotTime.getTime() + 15 * 60000);
                const startStr = formatTime(slot.hour, slot.minute);
                const endStr = formatTime(slotEnd.getHours(), slotEnd.getMinutes());
                
                let label = '';
                if (slot.label.includes('break')) {
                    label = ` (${slot.label})`;
                }
                
                slots.push({
                    id: `tomorrow-${index}`,
                    value: `tomorrow-${index}`,
                    text: `${startStr} - ${endStr}${label}`,
                    start_time: startStr,
                    end_time: endStr,
                    is_available: true,
                    is_today: false
                });
            });
            
            return slots;
        }

        // --- REST OF THE JS LOGIC REMAINS THE SAME, BUT RELIES ON MOCK/LIVE DATA ---

        function switchView(viewId) {
            console.log('Switching to view:', viewId);
            currentView = viewId;
            
            // Hide all views first
            document.querySelectorAll('.app-view').forEach(view => {
                view.classList.add('view-hidden');
            });
            
            // Show the target view
            const targetView = document.getElementById(`view-${viewId}`);
            if (targetView) {
                targetView.classList.remove('view-hidden');
                
                // Update QR code and render checkout summary when switching to checkout
                if (viewId === 'checkout') {
                    setTimeout(() => {
                        renderCheckoutSummary(); // Render the checkout items and total
                        const cartTotal = calculateCartTotal();
                        updateCheckoutQRCode(cartTotal);
                    }, 50);
                }
                console.log('Showing view:', viewId);
                
                // Special handling for shop view
                if (viewId === 'shop') {
                    console.log('Loading products for shop view');
                    fetchProducts(); 
                    renderCart(); // Update cart display on the sidebar
                    // Scroll to top when switching to shop view
                    window.scrollTo(0, 0);
                }
                
                // Special handling for cart view (The mobile sidebar has its own logic)
                if (viewId === 'cart') {
                    renderCart();
                }
                
                if (viewId === 'checkout') {
                    renderCheckoutSummary();
                    populateTimeSlots(); 
                    // Ensure Checkout button is active again
                    const confirmButton = document.getElementById('confirm-order-btn');
                    if (confirmButton) {
                        confirmButton.disabled = false;
                        confirmButton.textContent = 'Confirm Order & Pay';
                    }
                }
            } else {
                console.error(`View with ID view-${viewId} not found`);
                // Fallback for missing views like 'profile' or 'orders'
                if (viewId === 'profile' || viewId === 'orders' || viewId === 'confirmation') {
                    const fallbackView = document.getElementById(`view-${viewId}`);
                    if (fallbackView) fallbackView.classList.remove('view-hidden');
                }
            }
        }
        function closeItemDetails() {
            document.getElementById('item-detail-modal').classList.add('opacity-0', 'pointer-events-none');
        }
        
        function handleXeroxFileUpload(event) {
            const fileInput = event.target;
            uploadedFileName = (fileInput.files && fileInput.files.length > 0) ? fileInput.files[0].name : '';
            if (uploadedFileName) showToast(`Document selected: ${uploadedFileName}`, 'success');
            updateXeroxUI();
        }
        
        function updateBreadcrumbDisplay() {
            const currentBreadcrumb = document.getElementById('current-breadcrumb');
            const breadcrumbSearch = document.getElementById('breadcrumb-search');

            if (currentBreadcrumb) {
                currentBreadcrumb.textContent = activeCategory === 'All' ? 'All Products' : activeCategory.replace(/^[0-9]\.\s/, '');
            }
            if (breadcrumbSearch) {
                breadcrumbSearch.style.display = searchQuery ? 'flex' : 'none';
            }

            // Update the main document breadcrumb (which is outside the view container)
            const mainBreadcrumbCategory = document.getElementById('breadcrumb-category');
            if (mainBreadcrumbCategory) {
                mainBreadcrumbCategory.textContent = activeCategory === 'All' ? 'All Products' : activeCategory.replace(/^[0-9]\.\s/, '');
            }
            const mainBreadcrumbSearch = document.getElementById('breadcrumb-search');
            if(mainBreadcrumbSearch) {
                mainBreadcrumbSearch.style.display = searchQuery ? 'flex' : 'none';
                if (searchQuery) {
                     mainBreadcrumbSearch.querySelector('span').textContent = `Search Results for "${searchQuery}"`;
                }
            }
        }

        function renderProducts() { 
            const productGridContainer = document.getElementById('product-grid-container');
            if (!productGridContainer) {
                console.error('Product grid container not found');
                return;
            }

            console.log('Rendering products:', products);
            
            // Clear existing content
            productGridContainer.innerHTML = '';
            
            // Create the product grid container
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 w-full';
            productGridContainer.appendChild(grid);
            
            if (!products || products.length === 0) {
                grid.innerHTML = [
                    '<div class="col-span-full text-center py-12">',
                    '  <div class="text-5xl mb-4">üõí</div>',
                    '  <h3 class="text-xl font-semibold text-gray-700">No products found</h3>',
                    '  <p class="text-gray-500 mt-1">Try adjusting your filters or check back later</p>',
                    '</div>'
                ].join('');
                return;
            }

            // Filter products based on search query and active category
            let filteredProducts = products.filter(product => {
                if (!product || !product.name) return false;
                
                const searchLower = searchQuery ? searchQuery.toLowerCase() : '';
                const productName = product.name || '';
                const productDescription = product.description || '';
                const productCategory = product.category || 'Other';
                const productPrice = parseFloat(product.price) || 0;
                const isAvailable = product.is_available !== false; // Default to true if not specified
                
                // Search filter
                const matchesSearch = !searchLower || 
                                    productName.toLowerCase().includes(searchLower) || 
                                    productDescription.toLowerCase().includes(searchLower);
                
                // Category filter
                const matchesCategory = activeCategory === 'All' || productCategory === activeCategory;
                
                // Price filter
                let matchesPrice = true;
                if (selectedPriceFilter === 'upTo450') {
                    matchesPrice = productPrice <= 450;
                } else if (selectedPriceFilter === 'over450') {
                    matchesPrice = productPrice > 450;
                } else if (selectedPriceFilter === 'custom') {
                    matchesPrice = productPrice >= priceRange.min && productPrice <= priceRange.max;
                }

                return matchesSearch && matchesCategory && matchesPrice && isAvailable;
            });

            // Sort products with null checks
            filteredProducts.sort((a, b) => {
                const priceA = parseFloat(a.price) || 0;
                const priceB = parseFloat(b.price) || 0;
                const nameA = (a.name || '').toLowerCase();
                const nameB = (b.name || '').toLowerCase();
                
                if (sortBy === 'price_asc') {
                    return priceA - priceB;
                } else if (sortBy === 'price_desc') {
                    return priceB - priceA;
                } else if (sortBy === 'name_asc') {
                    return nameA.localeCompare(nameB);
                } else if (sortBy === 'name_desc') {
                    return nameB.localeCompare(nameA);
                }
                return 0;
            });

            // Check if we should show the Xerox banner
            const xeroxProduct = filteredProducts.find(p => p.id === XEROX_PRODUCT_ID);
            const otherProducts = filteredProducts.filter(p => p.id !== XEROX_PRODUCT_ID);
            
            // Show Xerox banner if applicable
            if (xeroxProduct && (activeCategory === 'All' || activeCategory === 'Service')) {
                const fileStatusText = uploadedFileName ? `File attached: ${uploadedFileName}` : (customXeroxQuantity > 0 ? 'WARNING: Please upload document!' : 'Upload document to continue');
                const fileStatusClass = uploadedFileName ? 'text-green-300' : (customXeroxQuantity > 0 ? 'text-red-400' : 'text-indigo-300');
                
                const xeroxBanner = document.createElement('div');
                xeroxBanner.className = 'col-span-full bg-indigo-700 p-6 rounded-2xl shadow-deep border-4 border-indigo-900 mb-8';
                xeroxBanner.innerHTML = `
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                        <div class="flex items-center mb-4 md:mb-0">
                            <img src="${xeroxProduct.image || 'https://placehold.co/100x100/d1d5db/374151?text=Xerox'}" 
                                 class="w-16 h-16 rounded-lg mr-4 object-cover" 
                                 alt="${xeroxProduct.name}">
                            <div>
                                <h3 class="text-xl font-bold text-white">${xeroxProduct.name}</h3>
                                <p class="text-sm text-indigo-200">${xeroxProduct.description || 'On-demand photocopying service'}</p>
                            </div>
                        </div>
                        <div class="w-full md:w-auto">
                            <div class="bg-indigo-900 p-3 rounded-lg mb-2">
                                <label class="block text-sm font-medium text-indigo-200 mb-1">Document (PDF/JPG/PNG)</label>
                                <input type="file" id="xerox-file-input" 
                                       onchange="handleXeroxFileUpload(event)" 
                                       class="w-full text-sm text-white file:mr-4 file:py-1.5 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-500 transition-colors">
                                <p id="xerox-file-status" class="text-xs mt-1 ${fileStatusClass}">${fileStatusText}</p>
                            </div>
                            <div class="flex items-center justify-between bg-white p-2 rounded-lg">
                                <span class="text-gray-700 font-medium">Pages:</span>
                                <div class="flex items-center space-x-2">
                                    <button onclick="handleXeroxChange(-1)" class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700 font-bold">-</button>
                                    <span id="xerox-quantity" class="w-12 text-center font-semibold">${customXeroxQuantity}</span>
                                    <button onclick="handleXeroxChange(1)" class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700 font-bold">+</button>
                                </div>
                                <span class="font-bold text-indigo-700">‚Çπ${(customXeroxQuantity * XEROX_PRICE_PER_PAGE).toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                `;
                grid.appendChild(xeroxBanner);
            }

            // Show product count
            if (filteredProducts.length > 0) {
                const countBanner = document.createElement('div');
                countBanner.className = 'col-span-full bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-6';
                countBanner.innerHTML = `
                    <p class="text-gray-700 font-medium">
                        Showing <span class="text-indigo-600 font-bold">${filteredProducts.length} ${filteredProducts.length === 1 ? 'product' : 'products'}</span>
                        ${searchQuery ? `matching "<span class="font-semibold">${searchQuery}</span>"` : ''}
                        ${activeCategory !== 'All' ? ` in <span class="font-semibold">${activeCategory}</span>` : ''}
                    </p>
                `;
                grid.appendChild(countBanner);
            }

            // Group products by category
            const productsByCategory = otherProducts.reduce((acc, product) => {
                const category = product.category || 'Uncategorized';
                if (!acc[category]) acc[category] = [];
                acc[category].push(product);
                return acc;
            }, {});

            // Define category display order
            const categoryOrder = [
                'Writing Instruments', 'Paper Products', 'Drawing & Geometry Tools',
                'Office & Desk Supplies', 'Art & Craft Supplies', 'Student Essentials',
                'Instruments & Calculators', 'Service', 'Uncategorized'
            ];

            // Sort categories by display order
            const sortedCategories = Object.keys(productsByCategory).sort((a, b) => {
                const indexA = categoryOrder.indexOf(a);
                const indexB = categoryOrder.indexOf(b);
                if (indexA === -1) return 1;
                if (indexB === -1) return -1;
                return indexA - indexB;
            });

            // Render products by category
            sortedCategories.forEach(category => {
                // Skip if no products in this category
                if (!productsByCategory[category] || productsByCategory[category].length === 0) return;

                // Add category header
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'col-span-full mt-6 mb-4';
                categoryHeader.innerHTML = `
                    <h3 class="text-xl font-bold text-gray-900 border-b pb-2">${category}</h3>
                `;
                grid.appendChild(categoryHeader);

                // Add products in this category
                productsByCategory[category].forEach(product => {
                    const productCard = document.createElement('div');
                    productCard.className = 'bg-white rounded-xl shadow-md overflow-hidden hover:shadow-lg transition-shadow duration-300 h-full flex flex-col';
                    
                    // Get the first image URL if available, or use a placeholder
                    const imageUrl = product.image || 'https://placehold.co/300x200/d1d5db/374151?text=No+Image';
                    
                    // Format price with 2 decimal places
                    const price = parseFloat(product.price || 0).toFixed(2);
                    
                    // Check if product is in cart
                    const inCart = cart[product.id] > 0;
                    
                    productCard.innerHTML = `
                        <div class="h-48 bg-gray-100 flex items-center justify-center overflow-hidden">
                            <img src="${imageUrl}" alt="${product.name}" class="h-full w-full object-cover hover:scale-105 transition-transform duration-300">
                        </div>
                        <div class="p-4 flex-grow flex flex-col">
                            <h3 class="font-semibold text-lg mb-1">${product.name}</h3>
                            <p class="text-gray-600 text-sm mb-3 flex-grow">${product.description || 'No description available'}</p>
                            <div class="flex justify-between items-center mt-auto">
                                <span class="font-bold text-indigo-600">‚Çπ${price}</span>
                                ${inCart ? `
                                    <div class="flex items-center space-x-2">
                                        <button onclick="changeQuantity(${product.id}, -1)" class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700 font-bold">-</button>
                                        <span class="text-sm font-medium">${cart[product.id]}</span>
                                        <button onclick="changeQuantity(${product.id}, 1)" class="w-8 h-8 flex items-center justify-center bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700 font-bold">+</button>
                                    </div>
                                ` : `
                                    <button onclick="addToCart(${product.id})" class="bg-indigo-600 text-white px-3 py-1.5 rounded-md text-sm font-medium hover:bg-indigo-700 transition-colors">
                                        Add to Cart
                                    </button>
                                `}
                            </div>
                        </div>
                    `;
                    
                    grid.appendChild(productCard);
                });
            });
            
            // If no products match the filters
            if (filteredProducts.length === 0) {
                const noProducts = document.createElement('div');
                noProducts.className = 'col-span-full text-center py-12';
                noProducts.innerHTML = `
                    <div class="text-5xl mb-4">üîç</div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-1">No products found</h3>
                    <p class="text-gray-500">Try adjusting your search or filters</p>
                    <button onclick="setCategoryFilter('All')" class="mt-4 text-indigo-600 hover:text-indigo-800 font-medium">
                        Show all products
                    </button>
                `;
                grid.appendChild(noProducts);
            }
            
            // Update breadcrumb display
            updateBreadcrumbDisplay();
        }
        
        function renderCategoriesSidebar() {
            const categoriesSidebar = document.getElementById('categories-sidebar');
            if (!categoriesSidebar) return;

            const uniqueCategories = new Set(products.map(p => p.category).filter(Boolean));
            // Ensure categories are sorted by the prefix number if present
            const sortedUniqueCategories = Array.from(uniqueCategories).sort();

            const categoryHtml = `
                <h3 class="text-lg font-bold text-gray-800 mb-3">Categories</h3>
                <ul class="space-y-2">
                    <li>
                        <button onclick="setCategoryFilter('All')" class="category-btn w-full text-left p-2 rounded-lg ${activeCategory === 'All' ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-gray-100 text-gray-700'}">All Products</button>
                    </li>
                    ${sortedUniqueCategories.map(cat => `
                        <li>
                            <button onclick="setCategoryFilter('${cat}')" class="category-btn w-full text-left p-2 rounded-lg ${activeCategory === cat ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-gray-100 text-gray-700'}">${cat.replace(/^[0-9]\.\s/, '')}</button>
                        </li>
                    `).join('')}
                </ul>
            `;
            categoriesSidebar.innerHTML = categoryHtml;
        }

        function setCategoryFilter(category) {
            activeCategory = category;
            renderProducts();
            document.querySelectorAll('.category-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold');
                btn.classList.add('hover:bg-gray-100', 'text-gray-700');
            });
            // Find and activate the button based on the category (stripping prefix if needed)
            const targetText = category === 'All' ? 'All Products' : category.replace(/^[0-9]\.\s/, '');
            const activeBtn = Array.from(document.querySelectorAll('.category-btn')).find(btn => btn.textContent === targetText);
            if (activeBtn) {
                activeBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
                activeBtn.classList.remove('hover:bg-gray-100', 'text-gray-700');
            }
        }

        function handleSearchInput(event) {
            searchQuery = event.target.value;
            renderProducts();
        }

        function setSortBy(value) {
            sortBy = value;
            renderProducts();
        }

        function toggleDeliveryFilter(filterName) {
            deliveryFilters[filterName] = !deliveryFilters[filterName];
            renderProducts();
        }

        function handlePriceRangeInput(event) {
            const slider = event.target;
            priceRange.max = parseInt(slider.value);
            document.getElementById('price-max-display').textContent = `‚Çπ${priceRange.max.toFixed(2)}+`;
            updatePriceRangeFill();
            selectedPriceFilter = 'custom'; 
            
            // Highlight the custom filter button
            document.querySelectorAll('.price-filter-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold');
                btn.classList.add('hover:bg-gray-100', 'text-gray-700');
            });
            const customBtn = document.querySelector('.price-filter-btn[data-filter="custom"]');
            if(customBtn) {
                customBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
                customBtn.classList.remove('hover:bg-gray-100', 'text-gray-700');
            }

            renderProducts();
        }

        function updatePriceRangeFill() {
            const slider = document.getElementById('price-range-slider');
            const fill = document.getElementById('price-range-fill');
            if(!slider || !fill) return;

            const min = parseInt(slider.min);
            const max = parseInt(slider.max);
            const current = parseInt(slider.value);
            const percentage = ((current - min) / (max - min)) * 100;
            fill.style.width = `${percentage}%`;
            fill.style.left = `${0}%`;
        }

        function setPriceFilter(filter) {
            selectedPriceFilter = filter;
            
            if (filter === 'All') {
                const priceSlider = document.getElementById('price-range-slider');
                if(priceSlider) priceSlider.value = priceRange.max;
                document.getElementById('price-max-display').textContent = `‚Çπ${priceRange.max.toFixed(2)}+`;
                updatePriceRangeFill();
            }

            renderProducts();
            
            // Update button states
            document.querySelectorAll('.price-filter-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-100', 'text-indigo-700', 'font-semibold');
                btn.classList.add('hover:bg-gray-100', 'text-gray-700');
            });
            
            const activeBtn = document.getElementById(`price-filter-${filter}`);
            if (activeBtn) {
                activeBtn.classList.add('bg-indigo-100', 'text-indigo-700', 'font-semibold');
                activeBtn.classList.remove('hover:bg-gray-100', 'text-gray-700');
            }
        }

        function toggleDealFilter(filterName) {
            dealFilters[filterName] = !dealFilters[filterName];
            renderProducts();
        }
        
        function renderCart() {
            const desktopContainer = document.getElementById('cart-items-container-desktop');
            const cartTotalElement = document.getElementById('cart-total');
            const cartCountElement = document.getElementById('cart-count');
            const subtotalElement = document.getElementById('cart-subtotal');
            
            if (!desktopContainer || !cartTotalElement || !cartCountElement || !subtotalElement) return;

            desktopContainer.innerHTML = '';
            let total = 0;
            let totalItems = 0;

            const productMap = products.reduce((map, p) => { map[p.id] = p; return map; }, {});
            const itemIds = Object.keys(cart).map(Number).filter(id => cart[id] > 0);

            // Start with a header if items exist, otherwise show empty message
            let cartContent = itemIds.length === 0 
                ? '<p class="text-gray-500 text-center py-6 border-t border-dashed">Your cart is empty. Start shopping!</p>'
                : '<p class="text-sm text-gray-500 font-bold uppercase mb-2">Order Summary</p>';


            itemIds.forEach(id => {
                const product = productMap[id];
                // Handle case where product might not be found (shouldn't happen with xerox fallback)
                if (!product) return; 

                const quantity = cart[id];
                const itemTotal = product.price * quantity;
                total += itemTotal;
                totalItems += quantity;

                const isXerox = product.id === XEROX_PRODUCT_ID;
                const fileDisplay = isXerox && uploadedFileName ? `<span class="text-xs text-indigo-300 block leading-tight">File: ${uploadedFileName}</span>` : '';
                const penaltyDisplay = isXerox ? `<span class="text-red-500 text-xs mt-1 font-semibold block">Penalty: ‚Çπ${(product.price * quantity).toFixed(2)} on cancellation!</span>` : '';
                const displayQuantity = isXerox ? `${quantity} pages` : quantity;


                const cartItem = `
                    <div class="flex items-center justify-between py-3 border-b border-gray-100">
                        <div class="flex items-start space-x-3">
                            <img src="${product.imageUrl}" alt="${product.name}" class="w-8 h-8 rounded-md object-cover flex-shrink-0 border border-gray-200">
                            
                            <div class="flex flex-col items-start">
                                <span class="text-base font-medium text-gray-800 leading-tight">${product.name}</span>
                                <span class="text-xs text-gray-500">@ ‚Çπ${product.price.toFixed(2)}</span>
                                ${fileDisplay}
                                ${penaltyDisplay}
                            </div>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button onclick="changeQuantity(${id}, -1)" class="text-gray-600 hover:text-red-600 font-bold p-1 rounded-full bg-gray-50">-</button>
                            <span class="font-bold text-sm min-w-[20px] text-center">${displayQuantity}</span>
                            <button onclick="changeQuantity(${id}, 1)" class="text-gray-600 hover:text-green-600 font-bold p-1 rounded-full bg-gray-50">+</button>
                        </div>
                    </div>
                `;
                cartContent += cartItem;
            });

            desktopContainer.innerHTML = cartContent;

            // Update both the subtotal and total to be the same since we're not showing fees
            subtotalElement.textContent = `‚Çπ${total.toFixed(2)}`;
            cartTotalElement.textContent = `‚Çπ${total.toFixed(2)}`;
            cartCountElement.textContent = totalItems.toString();
            
            updateMobileCartDisplay();

            // Re-render product cards in shop view to update quantity controls
            if (currentView === 'shop') { 
                renderProducts(); 
            }
        }

        function updateXeroxUI() {
            const xeroxInput = document.getElementById('xerox-quantity-input');
            const xeroxTotal = document.getElementById('xerox-total-price');
            const xeroxStatus = document.getElementById('xerox-file-status');

            const total = customXeroxQuantity * XEROX_PRICE_PER_PAGE;
            
            if(xeroxInput) xeroxInput.value = customXeroxQuantity;
            if(xeroxTotal) xeroxTotal.textContent = `‚Çπ${total.toFixed(2)}`;

            if(xeroxStatus) {
                // Re-read file name as the element might have been re-rendered
                const fileInput = document.getElementById('xerox-file-input');
                uploadedFileName = (fileInput && fileInput.files && fileInput.files.length > 0) ? fileInput.files[0].name : '';
                
                if(uploadedFileName) {
                    xeroxStatus.textContent = `File attached: ${uploadedFileName}`;
                    xeroxStatus.className = 'text-xs mt-1 font-medium text-green-300';
                } else {
                    xeroxStatus.textContent = customXeroxQuantity > 0 ? 'WARNING: Please upload document!' : 'Waiting for file...';
                    xeroxStatus.className = `text-xs mt-1 font-medium ${customXeroxQuantity > 0 ? 'text-red-400' : 'text-indigo-300'}`;
                }
            }

            if (customXeroxQuantity > 0) {
                if (!products.find(p => p.id === XEROX_PRODUCT_ID)) {
                     products.push({ id: XEROX_PRODUCT_ID, name: "Custom Xeroxing Service", price: XEROX_PRICE_PER_PAGE, stock: 9999, category: "Service", icon: "üìÑ", imageUrl: "https://placehold.co/100x100/d1d5db/374151?text=Xerox", description: "On-demand photocopying service. Price is per page. Note: Cancellation of xerox orders results in money deduction." });
                }
                cart[XEROX_PRODUCT_ID] = customXeroxQuantity;
            } else {
                delete cart[XEROX_PRODUCT_ID]; 
            }
            renderCart();
        }

        function handleXeroxChange(delta) {
            customXeroxQuantity = Math.max(0, customXeroxQuantity + delta);
            updateXeroxUI();
            if(customXeroxQuantity > 0 && delta > 0) {
                showToast("Xerox pages added. Service charges apply on cancellation.", 'info');
            }
        }

        function renderCheckoutSummary() {
            const summaryDiv = document.getElementById('checkout-summary-details');
            const finalTotal = document.getElementById('checkout-final-total');
            if (!summaryDiv || !finalTotal) return;

            let total = 0;
            const itemDetails = Object.keys(cart).map(id => {
                const isXerox = parseInt(id) === XEROX_PRODUCT_ID; 
                const product = products.find(p => p.id === parseInt(id));
                const finalProduct = product || products.find(p => p.id === XEROX_PRODUCT_ID && isXerox); 
                if (!finalProduct) return ''; // Skip if product not found

                const quantity = cart[id];
                const itemTotal = finalProduct.price * quantity;
                total += itemTotal;
                
                const fileInfo = isXerox && uploadedFileName ? ` (${uploadedFileName})` : '';
                const displayQuantity = isXerox ? `${quantity} pages` : quantity;


                return `
                    <li class="flex justify-between py-2 border-b border-gray-100 ${isXerox ? 'font-semibold text-red-700' : ''}">
                        <span class="text-gray-700 ${isXerox ? 'text-red-700' : ''}">${finalProduct.icon} ${finalProduct.name} x ${displayQuantity}${fileInfo}</span>
                        <span class="font-bold">‚Çπ${itemTotal.toFixed(2)}</span>
                    </li>
                `;
            }).join('');

            summaryDiv.innerHTML = `<ul class="space-y-1">${itemDetails}</ul>`;
            
            // Add subtotal
            const breakdownHtml = `
                <div class="flex justify-between text-base py-1 text-gray-700"><span>Total:</span><span>‚Çπ${total.toFixed(2)}</span></div>
            `;
            summaryDiv.innerHTML += breakdownHtml;

            finalTotal.textContent = `‚Çπ${total.toFixed(2)}`;
        }
        
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const currentQuantity = cart[productId] || 0;
            
            if (!product || product.stock <= 0 || currentQuantity + 1 > product.stock) {
                showToast(`Cannot add more. Only ${product.stock} left!`, 'warning');
                return;
            }

            cart[productId] = currentQuantity + 1;
            renderCart();
            showToast(`${product.name} added to cart!`, 'success');
        }

        function changeQuantity(productId, delta) {
            if (productId === XEROX_PRODUCT_ID) { 
                handleXeroxChange(delta);
                return;
            }
            
            const product = products.find(p => p.id === productId);
            if (!product) return;
            
            const currentQuantity = cart[productId] || 0;
            const newQuantity = currentQuantity + delta;

            if (newQuantity < 0) return;
            
            if (newQuantity > product.stock) {
                showToast(`Cannot add more. Only ${product.stock} left!`, 'warning');
                return;
            }

            if (newQuantity === 0) {
                delete cart[productId];
                showToast(`Removed ${product.name} from cart.`, 'info');
            } else {
                cart[productId] = newQuantity;
            }
            renderCart();
        }

        function proceedToCheckout() {
            if (Object.keys(cart).length === 0) {
                showToast("Your cart is empty. Please add items first.", 'warning');
                return;
            }
            switchView('checkout');
            // Ensure the checkout summary is rendered after the view switches
            setTimeout(renderCheckoutSummary, 50);
        }

        function confirmOrder() {
            handleCheckoutSubmit();
        }

        function toggleCart() {
            const cartSidebar = document.getElementById('cart-sidebar-mobile');
            const backdrop = document.getElementById('backdrop');
            cartSidebar.classList.toggle('translate-x-full');
            backdrop.classList.toggle('hidden');
            if (!cartSidebar.classList.contains('translate-x-full')) {
                 updateMobileCartDisplay(); // Use update to clone current desktop state
            }
        }

        function updateMobileCartDisplay() {
            const desktopContainer = document.getElementById('cart-items-container-desktop');
            const mobileCloneContainer = document.getElementById('cart-items-container-mobile-clone');
            
            if (desktopContainer && mobileCloneContainer) {
                // Clone the internal content
                mobileCloneContainer.innerHTML = desktopContainer.innerHTML;

                // We must re-wire event handlers on the cloned content manually for non-React/Angular apps.
                // Since the cart item HTML generation uses simple direct 'onclick' calls, 
                // we'll look for those buttons and re-assign the handlers.
                mobileCloneContainer.querySelectorAll('button[onclick]').forEach(button => {
                    const originalOnClick = button.getAttribute('onclick');
                    button.onclick = new Function(originalOnClick); // Re-attach the function
                });
            }

            const desktopCount = document.getElementById('cart-count');
            const desktopTotal = document.getElementById('cart-total');

            if (desktopCount) document.getElementById('cart-count-mobile').textContent = desktopCount.textContent;
            if (desktopTotal) document.getElementById('cart-total-mobile').textContent = desktopTotal.textContent;

        }

        function showToast(message, type) {
            const toast = document.getElementById('toast-notification');
            const toastText = document.getElementById('toast-text');
            // List all color classes used in toast for removal
            const allColorClasses = [
                'bg-green-600', 'border-green-800', 
                'bg-yellow-500', 'border-yellow-700', 
                'bg-blue-600', 'border-blue-800',
                'bg-red-600', 'border-red-800'
            ];
            const colors = {
                success: 'bg-green-600 border-green-800',
                warning: 'bg-yellow-500 border-yellow-700',
                info: 'bg-blue-600 border-blue-800',
                error: 'bg-red-600 border-red-800'
            };

            // FIX: Remove individual class tokens to avoid InvalidCharacterError
            allColorClasses.forEach(c => toast.classList.remove(c));

            const newColorClasses = colors[type].split(' ');

            toast.classList.add(...newColorClasses);
            toast.className = toast.className.replace(colors[type], newColorClasses.join(' ')); // This line is not strictly necessary after the fix above but preserves original logic flow structure

            toast.className = `fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] p-4 rounded-xl shadow-2xl text-white font-semibold transition-all duration-300 transform border-b-4 ${colors[type]}`;
            toastText.textContent = message;
            toast.classList.remove('opacity-0', 'translate-y-full');
            toast.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                toast.classList.remove('opacity-100', 'translate-y-0');
                toast.classList.add('opacity-0', 'translate-y-full');
            }, 3500);
        }

        // Function to generate QR code for Pay at Counter
        function generateCounterQRCode(amount) {
            const qrContainer = document.getElementById('counter-qr-code');
            if (!qrContainer) return;
            
            // Clear previous QR code
            qrContainer.innerHTML = '';
            
            // Update the displayed amount
            const qrAmountElement = document.getElementById('qr-amount');
            if (qrAmountElement) {
                qrAmountElement.textContent = `‚Çπ${amount.toFixed(2)}`;
            }
            
            // Create UPI payment URL
            const upiId = 'shopkeeper@upi';
            const merchantName = 'Campus Cart';
            const transactionNote = 'Order Payment';
            
            // Format: upi://pay?pa=<UPI ID>&pn=<Merchant Name>&am=<Amount>&tn=<Transaction Note>&cu=INR
            const upiUrl = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=${encodeURIComponent(merchantName)}` +
                         `&am=${amount}&tn=${encodeURIComponent(transactionNote)}&cu=INR`;
            
            // Generate QR code
            new QRCode(qrContainer, {
                text: upiUrl,
                width: 160,
                height: 160,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // Function to generate QR code for Razorpay payment
        function generateRazorpayQRCode(amount) {
            const qrContainer = document.getElementById('razorpay-qr-code');
            if (!qrContainer) return;
            
            // Clear previous QR code
            qrContainer.innerHTML = '';
            
            // Update the displayed amount
            const qrAmountElement = document.getElementById('razorpay-qr-amount');
            if (qrAmountElement) {
                qrAmountElement.textContent = `‚Çπ${amount.toFixed(2)}`;
            }
            
            // Create payment data for Razorpay
            const paymentData = {
                amount: Math.round(amount * 100), // Razorpay uses paise (1 INR = 100 paise)
                currency: 'INR',
                receipt: `order_${Date.now()}`,
                payment_capture: 1
            };
            
            // In a real implementation, you would make an API call to your backend
            // to create a Razorpay order and get the order ID
            // For demo purposes, we'll just show a static QR code
            const qrData = `razorpay:order?amount=${paymentData.amount}&currency=${paymentData.currency}&receipt=${paymentData.receipt}`;
            
            // Generate QR code
            new QRCode(qrContainer, {
                text: qrData,
                width: 160,
                height: 160,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // Update QR code when cart total changes
        function updateCartTotal() {
            const cartTotalElement = document.getElementById('cart-total');
            const checkoutTotalElement = document.getElementById('checkout-final-total');
            
            if (!cartTotalElement || !checkoutTotalElement) return;
            
            // Calculate subtotal
            let subtotal = 0;
            const productMap = products.reduce((map, p) => { map[p.id] = p; return map; }, {});
            
            Object.entries(cart).forEach(([id, quantity]) => {
                const product = productMap[parseInt(id)];
                if (product) {
                    subtotal += product.price * quantity;
                }
            });
            
            const estimatedFees = 20.00; // Mock delivery/processing fee
            const grandTotal = subtotal + estimatedFees;
            
            // Update UI
            cartTotalElement.textContent = `‚Çπ${grandTotal.toFixed(2)}`;
            checkoutTotalElement.textContent = `‚Çπ${grandTotal.toFixed(2)}`;
            
            // Update QR codes based on which payment method is selected
            const counterQrContainer = document.getElementById('counter-qr-container');
            const onlineQrContainer = document.getElementById('qr-code-container');
            const razorpayQrContainer = document.getElementById('razorpay-qr-container');
            const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked');
            
            if (selectedPaymentMethod) {
                if (selectedPaymentMethod.value === 'cod' && counterQrContainer && !counterQrContainer.classList.contains('hidden')) {
                    generateCounterQRCode(grandTotal);
                } else if (selectedPaymentMethod.value === 'online' && onlineQrContainer && !onlineQrContainer.classList.contains('hidden')) {
                    generateQRCode(grandTotal);
                } else if (selectedPaymentMethod.value === 'razorpay' && razorpayQrContainer && !razorpayQrContainer.classList.contains('hidden')) {
                    generateRazorpayQRCode(grandTotal);
                }
            }
            
            return grandTotal;
        }

        // Function to generate QR code for UPI payments
        function generateQRCode(amount) {
            const qrContainer = document.getElementById('payment-qr-code');
            if (!qrContainer) return;
            
            qrContainer.innerHTML = ''; // Clear previous QR code
            
            const upiId = 'shopkeeper@upi'; // Replace with actual shopkeeper's UPI ID
            const paymentData = `upi://pay?pa=${encodeURIComponent(upiId)}&pn=Shopkeeper&am=${amount.toFixed(2)}&cu=INR&tn=Order-${Date.now()}`;
            
            // Generate the QR code
            new QRCode(qrContainer, {
                text: paymentData,
                width: 160,
                height: 160,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });
        }

        // Define all functions first
        function initializeApp() {
            // Set up event listeners
            setupEventListeners();
            // Initial fetch of products
            fetchProducts();
        }

        function setupEventListeners() {
            // Add event listeners for payment method selection
            const paymentMethodInputs = document.querySelectorAll('input[name="payment-method"]');
            paymentMethodInputs.forEach(input => {
                input.addEventListener('change', handlePaymentMethodChange);
            });
            
            // Add other event listeners here
            document.addEventListener('DOMContentLoaded', initializeApp);
        }

        function handlePaymentMethodChange(e) {
            const value = e.target.value;
            const qrContainer = document.getElementById('qr-code-container');
            const counterQrContainer = document.getElementById('counter-qr-container');
            
            // Hide all QR containers first
            if (qrContainer) qrContainer.classList.add('hidden');
            if (counterQrContainer) counterQrContainer.classList.add('hidden');
            
            // Show the selected QR container
            if (value === 'online' && qrContainer) {
                qrContainer.classList.remove('hidden');
            } else if (value === 'counter' && counterQrContainer) {
                counterQrContainer.classList.remove('hidden');
            }
        }

        // Main initialization function
        function initializeApp() {
            // Initial fetch of products
            fetchProducts();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize UI components
            updateXeroxUI();
            renderCart();
            switchView('splash');
            populateTimeSlots();
            updatePriceRangeFill();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Payment method change handler
            const paymentMethodInputs = document.querySelectorAll('input[name="payment-method"]');
            paymentMethodInputs.forEach(input => {
                input.addEventListener('change', handlePaymentMethodChange);
            });
            
            // Add other event listeners here as needed
        }

        // Initialize the app when the DOM is fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded, initializing app...');
            // First ensure the product grid container exists
            const productGrid = document.getElementById('product-grid-container');
            if (!productGrid) {
                console.error('Product grid container not found in the DOM');
                // Try to find it again after a short delay
                setTimeout(() => {
                    const retryGrid = document.getElementById('product-grid-container');
                    if (retryGrid) {
                        console.log('Found product grid container after delay');
                        initializeApp();
                    } else {
                        console.error('Still cannot find product grid container');
                    }
                }, 500);
            } else {
                initializeApp();
            }
        });

        function initializeApp() {
            // Initial fetch of products
            fetchProducts();
            
            // Set up event listeners
            setupEventListeners();
            
            // Initialize UI components
            updateXeroxUI();
            renderCart();
            switchView('splash');
            populateTimeSlots();
            updatePriceRangeFill();
            
            // Set price filter
            setPriceFilter('All');

            // Initialize QR code for the selected payment method on page load
            const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked');
            if (selectedPaymentMethod) {
                const total = parseFloat(document.getElementById('checkout-final-total')?.textContent.replace('‚Çπ', '')) || 0;
                
                if (selectedPaymentMethod.value === 'cod') {
                    const counterQrContainer = document.getElementById('counter-qr-container');
                    if (counterQrContainer) {
                        counterQrContainer.classList.remove('hidden');
                        generateCounterQRCode(total);
                    }
                } else if (selectedPaymentMethod.value === 'razorpay') {
                    const razorpayQrContainer = document.getElementById('razorpay-qr-container');
                    if (razorpayQrContainer) {
                        razorpayQrContainer.classList.remove('hidden');
                        generateRazorpayQRCode(total);
                    }
                } else if (selectedPaymentMethod.value === 'online') {
                    const onlineQrContainer = document.getElementById('qr-code-container');
                    if (onlineQrContainer) {
                        onlineQrContainer.classList.remove('hidden');
                        generateQRCode(total);
                    }
                }
            }

            setTimeout(() => {
                const notificationBadge = document.getElementById('notification-badge');
                if (notificationBadge) notificationBadge.classList.remove('hidden');
                showToast("üîî Your order pickup is ready in 5 minutes! (Simulated)", 'warning');
            }, 5000);
        }
    </script>
</head>
<body class="bg-indigo-50 text-gray-800 antialiased min-h-screen pb-16 lg:pb-0">

    <!-- Item Detail Modal (New) -->
    <div id="item-detail-modal" class="modal fixed inset-0 bg-gray-900 bg-opacity-80 z-50 flex items-center justify-center opacity-0 pointer-events-none" onclick="closeItemDetails()">
        <div class="bg-white p-8 rounded-2xl shadow-2xl max-w-lg w-full m-4" onclick="event.stopPropagation()">
            <div class="flex justify-between items-start mb-6">
                <h3 id="modal-product-name" class="text-3xl font-extrabold text-indigo-700">Product Name</h3>
                <button onclick="closeItemDetails()" class="text-gray-500 hover:text-gray-900 p-1">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex space-x-6">
                <img id="modal-product-image" src="" alt="Product Image" class="w-32 h-32 rounded-xl object-cover border-2 border-gray-200 flex-shrink-0">
                <div>
                    <p id="modal-product-price" class="text-2xl font-bold text-gray-900 mb-1">‚Çπ0.00</p>
                    <p id="modal-product-stock" class="text-sm font-medium text-green-600 mb-4">Stock: 50 available</p>
                </div>
            </div>

            <h4 class="text-lg font-bold text-gray-800 mt-6 mb-2 border-t pt-4">Description</h4>
            <p id="modal-product-description" class="text-gray-600 leading-relaxed"></p>
            
            <button onclick="closeItemDetails()" class="btn-primary mt-8 w-full py-3 text-white font-bold rounded-xl shadow-lg">
                Got It! Back to Shop
            </button>
        </div>
    </div>
    <!-- End Item Detail Modal -->

    <!-- Toast Notification -->
    <div id="toast-notification" class="fixed bottom-5 left-1/2 -translate-x-1/2 z-[100] p-4 rounded-xl shadow-2xl text-white font-semibold transition-all duration-300 transform opacity-0 translate-y-full" style="min-width: 280px;">
        <span id="toast-text"></span>
    </div>

    <!-- Header / Navigation Bar -->
    <header class="bg-white shadow-deep sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <div class="flex items-center space-x-3 flex-shrink-0 cursor-pointer" onclick="switchView('splash')">
                <span class="text-3xl">üõçÔ∏è</span>
                <h1 class="text-2xl font-extrabold text-gray-900">Campus <span class="text-indigo-600">Cart</span></h1>
            </div>

            <!-- Search Bar (Now prominent in header) -->
            <div class="search-bar-container relative flex-grow mx-4">
                <input type="text" id="product-search-input" onkeyup="handleSearchInput(event)" placeholder="Search for products, categories..." 
                        class="w-full pl-10 pr-4 py-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent transition duration-150">
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg class="h-5 w-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>

            <div class="flex items-center space-x-6 flex-shrink-0">
                <!-- Language/Region (Mock) -->
                <button class="hidden lg:flex items-center space-x-1 text-gray-700 hover:text-indigo-600 transition duration-150 text-sm font-semibold p-2 rounded-lg hover:bg-indigo-50">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/7/7b/Flag_of_India_%282001%29.svg" alt="India Flag" class="w-5 h-auto rounded-sm">
                    <span>EN</span>
                    <svg class="w-4 h-4 ml-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                </button>

                <!-- Notifications Bell -->
                <button class="relative p-2 rounded-full text-gray-500 hover:text-indigo-600 transition duration-150" onclick="switchView('orders')">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0a3 3 0 11-6 0m6 0h-6"></path></svg>
                    <span id="notification-badge" class="hidden absolute top-1 right-1 h-2 w-2 rounded-full bg-red-600 ring-2 ring-white animate-ping"></span>
                </button>

                <!-- Profile/Login Placeholder -->
                <button onclick="switchView('profile')" class="hidden sm:block text-sm text-gray-700 hover:text-indigo-600 transition duration-150 p-2 rounded-lg hover:bg-indigo-50 text-right">
                    Hello, <span class="font-bold">Student!</span> <br> <span class="text-xs text-gray-500">Account & Lists</span>
                </button>

                <!-- Cart Button (Mobile/Tablet) -->
                <button onclick="toggleCart()" class="relative p-2 rounded-full bg-indigo-100 text-indigo-600 hover:bg-indigo-200 lg:hidden transition duration-150">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    <span id="cart-count-mobile" class="absolute top-0 right-0 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                </button>

                <!-- Desktop Cart Icon -->
                <a href="#" onclick="toggleCart()" class="hidden lg:flex flex-col items-center p-2 text-gray-500 hover:text-indigo-600 transition duration-150">
                    <div class="relative">
                        <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                        <span id="cart-count" class="absolute -top-1 -right-1 inline-flex items-center justify-center px-2 py-1 text-xs font-bold leading-none text-white transform translate-x-1/2 -translate-y-1/2 bg-red-600 rounded-full">0</span>
                    </div>
                    <span class="text-sm font-semibold mt-1">Cart</span>
                </a>
            </div>
        </div>
    </header>

    <!-- Breadcrumb Navigation (Simplified) -->
    <div class="bg-white py-2 px-4 border-b border-gray-200">
        <div class="max-w-7xl mx-auto">
            <nav class="text-sm" aria-label="Breadcrumb">
                <ol class="flex items-center space-x-2">
                    <li class="flex items-center">
                        <a href="#" onclick="switchView('splash')" class="text-indigo-600 hover:text-indigo-800 hover:underline">Home</a>
                        <svg class="h-4 w-4 text-gray-400 mx-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </li>
                    <li class="flex items-center">
                        <span id="breadcrumb-category" class="text-gray-700">All Products</span>
                        <svg id="breadcrumb-category-separator" class="h-4 w-4 text-gray-400 mx-2 view-hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                        </svg>
                    </li>
                    <li class="flex items-center view-hidden" id="breadcrumb-search">
                        <span class="text-indigo-600 font-medium">Search Results</span>
                    </li>
                </ol>
            </nav>
        </div>
    </div>

    <!-- Main Content Layout -->
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex space-x-6">
        
        <!-- Left Sidebar for Filters/Categories -->
        <aside id="left-sidebar" class="hidden lg:block lg:w-1/4 xl:w-1/5 pr-4 sticky top-[100px] h-fit max-h-[calc(100vh-108px)] overflow-y-auto">
            <div class="bg-white p-6 rounded-2xl shadow-deep border border-gray-200 space-y-8">
                
                <!-- Delivery Filters (Mock - Expanded to look like a table) -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Delivery Options (Mock)</h3>
                    <div class="border border-gray-200 rounded-lg overflow-hidden">
                        <div class="grid grid-cols-5 p-2 bg-indigo-50 text-xs font-semibold text-gray-600 uppercase border-b">
                            <span class="col-span-3">Service</span>
                            <span class="col-span-2 text-right">Fee/Info</span>
                        </div>
                        
                        <div class="space-y-1 p-2">
                            <label class="grid grid-cols-5 items-center text-gray-700 hover:bg-gray-50 p-1 rounded transition">
                                <input type="checkbox" onchange="toggleDeliveryFilter('allPrime')" class="form-checkbox h-4 w-4 text-indigo-600 rounded mr-2 col-span-1" ${deliveryFilters.allPrime ? 'checked' : ''}>
                                <span class="col-span-2 text-sm">All Prime</span>
                                <span class="col-span-2 text-right text-sm font-medium text-green-600">FREE</span>
                            </label>
                            <label class="grid grid-cols-5 items-center text-gray-700 hover:bg-gray-50 p-1 rounded transition">
                                <input type="checkbox" onchange="toggleDeliveryFilter('primeDelivery')" class="form-checkbox h-4 w-4 text-indigo-600 rounded mr-2 col-span-1" ${deliveryFilters.primeDelivery ? 'checked' : ''}>
                                <span class="col-span-2 text-sm">Express Pickup</span>
                                <span class="col-span-2 text-right text-sm font-medium text-indigo-600">‚Çπ20.00</span>
                            </label>
                            <label class="grid grid-cols-5 items-center text-gray-700 hover:bg-gray-50 p-1 rounded transition">
                                <input type="checkbox" onchange="toggleDeliveryFilter('getItByTomorrow')" class="form-checkbox h-4 w-4 text-indigo-600 rounded mr-2 col-span-1" ${deliveryFilters.getItByTomorrow ? 'checked' : ''}>
                                <span class="col-span-2 text-sm">Next Day (Std)</span>
                                <span class="col-span-2 text-right text-xs text-gray-500">Normal</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Price Range Filter -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Price</h3>
                    <div class="flex items-center justify-between mb-4">
                        <span id="price-min-display" class="font-semibold text-gray-700">‚Çπ0</span>
                        <span id="price-max-display" class="font-semibold text-gray-700">‚Çπ${priceRange.max.toFixed(2)}+</span>
                    </div>
                    <div class="range-slider mb-4">
                        <div id="price-range-fill" class="range-fill"></div>
                        <input type="range" id="price-range-slider" min="0" value="${priceRange.max}" 
                                oninput="handlePriceRangeInput(event)" onchange="renderProducts()">
                    </div>
                    <div class="flex space-x-2">
                        <button onclick="setPriceFilter('All')" id="price-filter-All" 
                                class="price-filter-btn w-1/2 p-2 rounded-lg text-center text-sm border border-gray-300 transition hover:bg-gray-100 text-gray-700"
                                data-filter="All">
                            All
                        </button>
                        <button onclick="setPriceFilter('custom')" id="price-filter-custom"
                                class="price-filter-btn w-1/2 p-2 rounded-lg text-center text-sm border border-gray-300 transition hover:bg-gray-100 text-gray-700"
                                data-filter="custom">
                            Apply
                        </button>
                    </div>
                    <ul class="space-y-2 mt-4">
                        <li>
                            <button onclick="setPriceFilter('upTo450')" id="price-filter-upTo450"
                                    class="price-filter-btn w-full text-left p-2 rounded-lg hover:bg-gray-100 text-gray-700"
                                    data-filter="upTo450">
                                Up to ‚Çπ450
                            </button>
                        </li>
                        <li>
                            <button onclick="setPriceFilter('over450')" id="price-filter-over450"
                                    class="price-filter-btn w-full text-left p-2 rounded-lg hover:bg-gray-100 text-gray-700"
                                    data-filter="over450">
                                Over ‚Çπ450
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Categories -->
                <div id="categories-sidebar">
                    <!-- Categories will be rendered here by renderCategoriesSidebar() -->
                </div>

                <!-- Deals & Discounts (Mock) -->
                <div>
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Deals & Discounts (Mock)</h3>
                    <ul class="space-y-2">
                        <li>
                            <label class="flex items-center text-gray-700">
                                <input type="checkbox" onchange="toggleDealFilter('allDiscounts')" class="form-checkbox h-4 w-4 text-indigo-600 rounded mr-2" ${dealFilters.allDiscounts ? 'checked' : ''}>
                                All Discounts
                            </label>
                        </li>
                        <li>
                            <label class="flex items-center text-gray-700">
                                <input type="checkbox" onchange="toggleDealFilter('todayDeals')" class="form-checkbox h-4 w-4 text-indigo-600 rounded mr-2" ${dealFilters.todayDeals ? 'checked' : ''}>
                                Today's Deals
                            </label>
                        </li>
                    </ul>
                </div>
            </div>
        </aside>

        <!-- Dynamic Main Content Area -->
        <main class="w-full lg:w-3/4 xl:w-4/5">
            
            <!-- 0. Splash View (First Page) -->
            <section id="view-splash" class="app-view">
                <div class="bg-white p-8 rounded-3xl shadow-deep border-4 border-indigo-200 text-center">
                    <h2 class="text-4xl font-extrabold text-indigo-700 mb-2">Welcome to Campus Cart!</h2>
                    <p class="text-xl text-gray-600 mb-8">Your fast lane to campus stationery essentials.</p>

                    <!-- Key Feature Highlight -->
                    <div class="bg-red-50 p-4 rounded-xl border border-red-300 mb-8 max-w-2xl mx-auto">
                        <p class="text-lg font-bold text-red-700">üõë Skip the Break Time Queue!</p>
                        <p class="text-sm text-gray-600">Order, select a 15-minute pickup slot, and collect instantly. No more waiting!</p>
                    </div>

                    <!-- Item Showcase with Mock Images -->
                    <div class="grid grid-cols-3 gap-4 mb-10 max-w-xl mx-auto">
                        <div class="bg-gray-100 p-3 rounded-xl shadow-md">
                            <img src="https://placehold.co/150x100/93c5fd/1e40af?text=Notebook" alt="Notebook Placeholder" class="splash-card-image rounded-lg mb-2">
                            <p class="text-sm font-semibold text-gray-700">A4 Notebooks</p>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-xl shadow-md">
                            <img src="https://placehold.co/150x100/fecaca/991b1b?text=Pens" alt="Pens Placeholder" class="splash-card-image rounded-lg mb-2">
                            <p class="text-sm font-semibold text-gray-700">Blue/Black Pens</p>
                        </div>
                        <div class="bg-gray-100 p-3 rounded-xl shadow-md">
                            <img src="https://placehold.co/150x100/d1d5db/374151?text=Xerox" alt="Xerox Placeholder" class="splash-card-image rounded-lg mb-2">
                            <p class="text-sm font-semibold text-gray-700">Xerox Service</p>
                        </div>
                    </div>

                    <button onclick="switchView('shop')" class="btn-primary px-10 py-4 text-white font-extrabold text-xl rounded-xl shadow-lg">
                        Go to Shop ‚ú®
                    </button>
                    <p class="text-sm text-gray-500 mt-4">Check out our latest arrivals and special offers!</p>
                </div>
            </section>
            
            <!-- 1. Shop View (Main Shopping Page with Filters/Search) -->
            <section id="view-shop" class="app-view view-hidden">
                <div class="flex items-center justify-between mb-6">
                    <!-- Breadcrumbs -->
                    <nav class="text-sm text-gray-500">
                        <ol class="list-none p-0 inline-flex">
                            <li class="flex items-center">
                                <a href="#" onclick="switchView('splash')" class="text-indigo-600 hover:underline">Home</a>
                                <span class="mx-2">/</span>
                            </li>
                            <!-- Dynamic Category/Search Breadcrumb -->
                            <li class="flex items-center">
                                <span id="current-breadcrumb" class="text-gray-700">All Products</span>
                                <span id="search-separator" class="mx-2 hidden">/</span>
                            </li>
                            
                            <li class="flex items-center view-hidden" id="breadcrumb-search-dynamic">
                                <span class="text-gray-700 font-semibold">Search Results for ""</span>
                            </li>
                        </ol>
                    </nav>

                    <!-- Sort By Dropdown -->
                    <div class="relative">
                        <select onchange="setSortBy(this.value)" class="block appearance-none w-full bg-white border border-gray-300 text-gray-700 py-2 px-4 pr-8 rounded-md shadow leading-tight focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent">
                            <option value="featured" ${sortBy === 'featured' ? 'selected' : ''}>Sort By: Featured</option>
                            <option value="price_asc" ${sortBy === 'price_asc' ? 'selected' : ''}>Sort By: Price: Low to High</option>
                            <option value="price_desc" ${sortBy === 'price_desc' ? 'selected' : ''}>Sort By: Price: High to Low</option>
                            <option value="name_asc" ${sortBy === 'name_asc' ? 'selected' : ''}>Sort By: Name: A to Z</option>
                        </select>
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-gray-700">
                            <svg class="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 6.757 7.586 5.343 9z"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Promotional Banner (Mimicking Amazon Pay Gift Card) -->
                <div class="bg-gradient-to-r from-purple-600 to-indigo-700 p-6 rounded-2xl shadow-deep mb-8 flex flex-col md:flex-row items-center justify-between">
                    <div class="flex items-center mb-4 md:mb-0">
                        <img src="https://placehold.co/100x100/f5d0fe/a21caf?text=Gift" alt="Campus Cart Gift Card" class="w-20 h-20 rounded-lg mr-4 object-cover">
                        <div>
                            <h3 class="text-2xl font-bold text-white">Campus Cart Gift Card</h3>
                            <p class="text-sm text-purple-200">This festive season, give a gift of choice!</p>
                        </div>
                    </div>
                    <button class="bg-white text-indigo-700 font-bold py-2 px-6 rounded-lg hover:bg-gray-100 transition duration-150 shadow-md">
                        Shop Gift Cards
                    </button>
                </div>
                
                <!-- Product Grid (Dashboard content) -->
                <div id="product-grid-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6 product-card-grid">
                    <!-- Products/Categories will be injected here by renderProducts() -->
                </div>
            </section>

            <!-- 3. Checkout View -->
            <section id="view-checkout" class="app-view view-hidden">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-8 border-b pb-2">Checkout Details</h2>
                <div class="bg-white p-8 rounded-2xl shadow-deep space-y-6">
                    
                    <!-- Step 1: Order Summary -->
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">1. Review Items</h3>
                        <div id="checkout-summary-details" class="bg-gray-100 p-4 rounded-xl max-h-60 overflow-y-auto border border-dashed border-gray-300">
                            <!-- Summary details rendered here (includes breakdown from JS) -->
                        </div>
                        <div class="flex justify-between font-extrabold text-2xl pt-4">
                            <span>Order Total:</span>
                            <span id="checkout-final-total" class="text-indigo-600">‚Çπ0.00</span>
                        </div>
                    </div>

                    <!-- Step 2: Pickup Slot (Dynamic and Realistic) -->
                    <div class="border-b pb-4">
                        <h3 class="text-xl font-bold text-gray-800 mb-3">2. Select Pickup Time Slot</h3>
                        <p class="text-sm text-red-600 mb-3 font-semibold">Choose carefully: Orders not collected within the 15-minute slot will be cancelled and subject to penalty (if xerox included).</p>
                        <select id="pickup-time-slot" class="w-full p-4 border-2 border-indigo-300 rounded-xl bg-indigo-50 text-lg font-medium focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                            <option value="">-- Generating Available Slots... --</option>
                        </select>
                    </div>

                    <!-- Step 3: Payment Method -->
                    <div class="pb-4">
                            <h3 class="text-xl font-bold text-gray-800 mb-3">3. Payment Method</h3>
                            <div class="space-y-3">
                                <label class="flex items-start space-x-3 p-4 bg-gray-50 rounded-xl shadow-md hover:bg-indigo-50 cursor-pointer transition border border-gray-200">
                                    <input type="radio" name="payment-method" value="online" class="form-radio h-6 w-6 text-indigo-600 border-2 border-indigo-400 mt-1">
                                    <div class="flex-1">
                                        <div class="flex items-center justify-between">
                                            <span class="font-semibold text-gray-800 text-lg">Online Payment (UPI/Wallet QR)</span>
                                        </div>
                                        <!-- QR Code Container (initially hidden) -->
                                        <div id="qr-code-container" class="mt-4 hidden">
                                            <div class="flex flex-col items-center bg-white p-4 rounded-lg border-2 border-dashed border-indigo-200">
                                                <div id="payment-qr-code" class="w-40 h-40 bg-white p-2 rounded-lg border border-gray-200 flex items-center justify-center">
                                                    <!-- QR code will be generated here -->
                                                </div>
                                                <p class="text-sm text-gray-600 mt-2 text-center">Scan to pay with any UPI app</p>
                                                <div class="flex space-x-2 mt-2">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/UPI-Logo-vector.svg" alt="UPI" class="h-5">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/PhonePe_Logo.svg" alt="PhonePe" class="h-5">
                                                    <img src="https://upload.wikimedia.org/wikipedia/commons/0/0f/Paytm_Logo_%28standalone%29.svg" alt="Paytm" class="h-5">
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                <label class="flex items-start space-x-3 p-4 bg-gray-50 rounded-xl shadow-md hover:bg-indigo-50 cursor-pointer transition border border-gray-200">
                                    <input type="radio" name="payment-method" value="razorpay" class="form-radio h-6 w-6 text-indigo-600 border-2 border-indigo-400 mt-1">
                                    <div class="flex-1">
                                        <span class="font-semibold text-gray-800 text-lg">Razorpay/Card (Simulated)</span>
                                        <p class="text-sm text-gray-500 mt-1">Scan QR code to pay with Razorpay</p>
                                        <!-- Razorpay QR Code Container (initially hidden) -->
                                        <div id="razorpay-qr-container" class="mt-4 hidden">
                                            <div class="flex flex-col items-center bg-white p-4 rounded-lg border-2 border-dashed border-indigo-200">
                                                <div id="razorpay-qr-code" class="w-40 h-40 bg-white p-2 rounded-lg border border-gray-200 flex items-center justify-center">
                                                    <!-- QR code will be generated here -->
                                                </div>
                                                <p class="text-sm text-gray-600 mt-2 text-center">Scan to pay with Razorpay</p>
                                                <p class="text-xs text-gray-500 mt-1 text-center">Order Total: <span id="razorpay-qr-amount" class="font-bold">‚Çπ0.00</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                                <label class="flex items-start space-x-3 p-4 bg-gray-50 rounded-xl shadow-md hover:bg-indigo-50 cursor-pointer transition border border-gray-200">
                                    <input type="radio" name="payment-method" value="cod" class="form-radio h-6 w-6 text-indigo-600 border-2 border-indigo-400 mt-1">
                                    <div class="flex-1">
                                        <span class="font-semibold text-gray-800 text-lg">Pay at Counter</span>
                                        <p class="text-sm text-gray-500 mt-1">Show QR code to shopkeeper for payment</p>
                                        <!-- QR Code Container (initially hidden) -->
                                        <div id="counter-qr-container" class="mt-4 hidden">
                                            <div class="flex flex-col items-center bg-white p-4 rounded-lg border-2 border-dashed border-indigo-200">
                                                <div id="counter-qr-code" class="w-40 h-40 bg-white p-2 rounded-lg border border-gray-200 flex items-center justify-center">
                                                    <!-- QR code will be generated here -->
                                                </div>
                                                <p class="text-sm text-gray-600 mt-2 text-center">Show this QR code to the shopkeeper</p>
                                                <p class="text-xs text-gray-500 mt-1 text-center">Order Total: <span id="qr-amount" class="font-bold">‚Çπ0.00</span></p>
                                            </div>
                                        </div>
                                    </div>
                                </label>
                             </div>
                    </div>

                    <button id="confirm-order-btn" onclick="confirmOrder()" class="btn-primary w-full py-4 text-white font-extrabold text-xl rounded-xl shadow-lg">
                        Confirm Order & Pay
                    </button>
                </div>
            </section>

            <!-- 4. Order Confirmation View -->
            <section id="view-confirmation" class="app-view view-hidden text-center">
                <div class="bg-white p-10 rounded-3xl shadow-deep max-w-xl mx-auto border-4 border-green-400/50">
                    <span class="text-7xl block mb-6">üéâ</span>
                    <h2 class="text-4xl font-extrabold text-green-700 mb-2">Order Finalized!</h2>
                    <p class="text-gray-600 text-lg mb-8">Your order is locked in for pickup during the selected slot.</p>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <!-- Pickup Code -->
                        <div class="bg-indigo-50 p-6 rounded-xl border border-indigo-300 shadow-inner">
                            <p class="text-sm font-semibold text-gray-700 uppercase mb-2">Your Unique Pickup Code</p>
                            <h3 id="order-code-display" class="text-4xl font-black text-indigo-800 tracking-widest my-1">
                                <!-- Code will be injected here --></h3>
                            <p class="text-xs text-gray-500">Show this code to the shopkeeper.</p>
                        </div>
                        
                        <!-- Shopkeeper's UPI QR Code -->
                        <div class="bg-white p-4 rounded-xl border border-gray-300 shadow-md flex flex-col items-center justify-center">
                            <div id="shopkeeper-qr-code" class="w-40 h-40 p-2 bg-white rounded-lg flex items-center justify-center">
                                <!-- QR code will be generated here -->
                            </div>
                            <p id="qr-mock-text" class="text-sm text-gray-700 mt-2 font-semibold">
                                <!-- Payment method and total injected here --></p>
                            <p class="text-xs text-indigo-600 mt-1">Scan with any UPI app to pay</p>
                            <div class="mt-2 flex space-x-2">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/0/04/UPI-Logo-vector.svg" alt="UPI" class="h-5">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/5/5e/PhonePe_Logo.svg" alt="PhonePe" class="h-5">
                                <img src="https://upload.wikimedia.org/wikipedia/commons/0/0f/Paytm_Logo_%28standalone%29.svg" alt="Paytm" class="h-5">
                            </div>
                        </div>
                    </div>
                    
                    <p id="cancellation-details" class="text-sm text-red-700 bg-red-100 p-3 rounded-lg font-medium mb-8 border border-red-300">
                        <!-- Cancellation details injected here -->
                    </p>

                    <button onclick="switchView('shop')" class="px-8 py-3 btn-primary text-white font-bold rounded-xl shadow-lg">
                        Go to Shop
                    </button>
                </div>
            </section>
            
            <!-- Placeholder Views -->
            <section id="view-orders" class="app-view view-hidden">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">My Orders (Placeholder)</h2>
                <div class="p-6 bg-white rounded-2xl shadow-deep">
                    <p class="text-gray-600">This view will show your history, order status (e.g., Ready for Pickup), and allow for quick re-order. (Placeholder)</p>
                </div>
            </section>
            <section id="view-profile" class="app-view view-hidden">
                <h2 class="text-3xl font-extrabold text-gray-900 mb-6 border-b pb-2">Student Profile (Placeholder)</h2>
                <div class="p-6 bg-white rounded-2xl shadow-deep">
                    <p class="text-gray-600">This view contains user settings and notification preferences. (Placeholder)</p>
                    <p class="mt-4 text-sm text-gray-500">User ID: <span class="font-mono text-indigo-600">${userId}</span></p>
                </div>
            </section>
        </main>

        <!-- Shopping Cart Sidebar (Desktop) -->
        <aside id="cart-sidebar-desktop" class="hidden lg:block lg:w-1/4 xl:w-1/5 pl-4 sticky top-[100px] h-[calc(100vh-108px)]">
            <div class="bg-white p-6 rounded-2xl shadow-deep border border-indigo-200 h-full flex flex-col">
                <h2 class="text-2xl font-bold text-indigo-700 mb-4 border-b pb-2 flex justify-between items-center">
                    Shopping Cart 
                    <span id="cart-count" class="text-base bg-red-600 text-white px-3 py-1 rounded-full font-bold">0</span>
                </h2>
                
                <!-- Cart Items Container -->
                <div id="cart-items-container-desktop" class="flex-grow overflow-y-auto mb-6 pr-1">
                    <!-- Cart items will be injected here by renderCart() -->
                </div>

                <!-- Filters in Cart (Mock) -->
                <div class="mb-4 pt-4 border-t border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-3">Cart Filters (Mock)</h3>
                    <ul class="space-y-2 text-sm">
                        <li>
                            <label class="flex items-center text-gray-700">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 rounded mr-2">
                                Group by Category
                            </label>
                        </li>
                        <li>
                            <label class="flex items-center text-gray-700">
                                <input type="checkbox" class="form-checkbox h-4 w-4 text-indigo-600 rounded mr-2">
                                Show only items in stock
                            </label>
                        </li>
                    </ul>
                </div>

                <!-- Cart Summary & Checkout (Expanded) -->
                <div class="space-y-3 pt-4 border-t border-gray-200 mt-auto">
                    <!-- Breakdown Table -->
                    <div class="space-y-1 text-base">
                        <div class="flex justify-between text-gray-700 border-b pb-2 border-dashed">
                            <span>Total:</span>
                            <span id="cart-subtotal" class="font-semibold">‚Çπ0.00</span>
                        </div>
                    </div>

                    <!-- Grand Total -->
                    <div class="flex justify-between items-center font-extrabold text-2xl">
                        <span>Grand Total:</span>
                        <span id="cart-total" class="text-indigo-600">‚Çπ0.00</span>
                    </div>
                    <button onclick="proceedToCheckout()" class="btn-primary w-full py-3 text-white font-bold text-lg rounded-xl shadow-lg">
                        Proceed to Checkout
                    </button>
                    <p class="text-xs text-center text-gray-500 mt-2">
                        You're just one step away!
                    </p>
                </div>
            </div>
        </aside>
    </div>

    <!-- Mobile Cart Sidebar (Overlay) -->
    <div id="backdrop" onclick="toggleCart()" class="fixed inset-0 bg-gray-900 bg-opacity-70 z-40 lg:hidden hidden transition-opacity duration-300"></div>

    <aside id="cart-sidebar-mobile" class="fixed top-0 right-0 w-full max-w-xs h-full bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 lg:hidden p-6 flex flex-col">
        <div class="flex justify-between items-center pb-4 border-b">
            <h2 class="text-2xl font-bold text-indigo-700">Your Cart</h2>
            <button onclick="toggleCart()" class="p-2 text-gray-500 hover:text-gray-900">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        
        <!-- Cart Items Container (Mobile Clone) -->
        <div id="cart-items-container-mobile-clone" class="flex-grow overflow-y-auto my-4">
             <!-- Cloned cart items -->
        </div>
        
        <div class="p-4 bg-white border-t space-y-3">
            <div class="flex justify-between items-center font-extrabold text-xl">
                <span>Total:</span>
                <span id="cart-total-mobile" class="text-indigo-600">‚Çπ0.00</span>
            </div>
            <button onclick="proceedToCheckout(); toggleCart();" class="btn-primary w-full py-3 text-white font-bold text-lg rounded-xl shadow-lg">
                Proceed to Checkout
            </button>
        </div>
    </aside>

    <!-- Mobile Bottom Navigation -->
    <nav class="fixed bottom-0 left-0 right-0 lg:hidden bg-white border-t border-gray-200 shadow-2xl z-50">
        <div class="flex justify-around items-center h-16">
            <button class="nav-btn flex flex-col items-center justify-center p-2 text-gray-500 hover:text-indigo-600 transition-colors" onclick="switchView('shop')" data-view-target="shop">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0h6"></path></svg>
                <span class="text-xs font-semibold">Shop</span>
            </button>
            <button class="nav-btn flex flex-col items-center justify-center p-2 text-gray-500 hover:text-indigo-600 transition-colors" onclick="switchView('orders')" data-view-target="orders">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                <span class="text-xs font-semibold">Orders</span>
            </button>
            <button class="nav-btn flex flex-col items-center justify-center p-2 text-gray-500 hover:text-indigo-600 transition-colors" onclick="switchView('profile')" data-view-target="profile">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                <span class="text-xs font-semibold">Profile</span>
            </button>
        </div>
    </nav>
</body>
</html>
